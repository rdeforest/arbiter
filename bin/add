#!/bin/bash

# add "definition or dynamic" [to] "world"

cd $ARB_DATA

item="$1"

shift

world="$2"
[ "$2" ] || world="$1"

if [ -e "definitions/$item" ]; then
    item_type=definitions
fi

if [ -e "dynamics/$item" ]; then
    item_type=dynamics
fi

if [ ! "$item_type" ]; then
    echo "No definition or dynamic found named '$item'"
    exit
fi

if [ ! -e "worlds/$world" ]; then
    echo "No world found named '$world'"
    exit
fi

cd worlds/$world

for def in definitions/*; do 
    if [ -e "$def" ]; then
        if ! $def/add-to-world $item_type $item; then
            echo "'$def' objected to addition of $item ($item_type)"
            exit
        fi
    fi
done

n=0

while [ -e $item_type/$n-* ]; do
    n=$[ $n + 1 ]
done

ln -s ../../../$item_type/$item $item_type/$n-$item
